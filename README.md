# message_filter
nekro_agent平台插件消息正则过滤器
"""
消息关键词过滤器

这个插件通过用户消息回调机制，根据用户ID和消息中的正则表达式模式对消息进行过滤，
决定是否触发AI响应。支持私聊和群聊的独立配置，每个用户可以配置独立的正则表达式模式。

## 主要功能

- **私聊/群聊独立配置**: 可分别为私聊和群聊设置不同的过滤规则
- **正则表达式匹配**: 支持强大的正则表达式模式匹配，提供更精细的控制
- **个性化模式过滤**: 为每个用户配置独立的正则表达式模式
- **灵活阻止模式**: 可选择是否保存被过滤的消息记录
- **优雅降级**: 异常情况下默认放行消息，确保系统稳定性

## 配置说明

### 1. 生效范围配置
- **启用私聊过滤 (ENABLE_PRIVATE)**: 控制是否在私聊频道启用过滤功能
- **启用群聊过滤 (ENABLE_GROUP)**: 控制是否在群聊频道启用过滤功能

### 2. 私聊配置
- **私聊目标用户ID列表 (PRIVATE_TARGET_USER_IDS)**: 私聊中需要过滤的用户ID列表
- **私聊用户正则模式列表 (PRIVATE_USER_PATTERNS)**: 与私聊用户ID一一对应的正则表达式

### 3. 群聊配置
- **群聊目标用户ID列表 (GROUP_TARGET_USER_IDS)**: 群聊中需要过滤的用户ID列表
- **群聊用户正则模式列表 (GROUP_USER_PATTERNS)**: 与群聊用户ID一一对应的正则表达式

### 4. 其他配置
- **阻止模式 (BLOCK_MODE)**: 0=完全阻止且不保存记录，1=阻止AI响应但保存记录
- **私聊默认正则模式 (DEFAULT_PRIVATE_PATTERN)**: 私聊中的默认正则表达式
- **群聊默认正则模式 (DEFAULT_GROUP_PATTERN)**: 群聊中的默认正则表达式

## 正则表达式示例

### 基础匹配
- `@AI|@助手`: 包含"@AI"或"@助手"
- `^@.*`: 以"@"开头的消息
- `.*问题.*`: 包含"问题"关键词的消息

### 高级模式
- `^(?!.*@\s*(代码助手|曦)).*$`: 排除包含"@代码助手"或"@曦"的消息
- `^(?=.*@AI)(?=.*请求).*$`: 必须同时包含"@AI"和"请求"
- `^\s*@AI\s+.{5,}$`: "@AI"后跟至少5个字符

## 配置示例

### 示例1: 基础配置
```
启用私聊过滤: True
启用群聊过滤: False
私聊目标用户ID列表: ["user123", "user456"]
私聊用户正则模式列表: ["@助手", "^@AI.*"]
阻止模式: 1
私聊默认正则模式: "@AI"
```

### 示例2: 高级配置
```
启用私聊过滤: True
启用群聊过滤: True
私聊目标用户ID列表: ["user123"]
私聊用户正则模式列表: ["^(?=.*@助手)(?=.*请求).*$"]
群聊目标用户ID列表: ["user456"]
群聊用户正则模式列表: ["^@AI\\s+"]
```

## 使用场景

### 场景1: 私聊专属唤醒词
- 用户在私聊中必须使用特定格式才能唤醒AI
- 例如："@助手 帮我..."才会触发，单独的"你好"不会触发

### 场景2: 群聊@提及过滤
- 群聊中只有正确@提及AI才会响应
- 避免AI对无关对话进行响应

### 场景3: 排除特定模式
- 使用负向匹配排除不想触发的消息
- 例如：排除包含某些敏感词的消息

## 工作原理

1. **频道类型检查**: 根据配置检查是否在当前频道类型启用过滤
2. **用户身份识别**: 获取消息发送者的用户ID
3. **映射构建**: 根据频道类型构建用户到正则模式的映射关系
4. **正则匹配**: 使用正则表达式检查消息内容是否匹配用户模式
5. **执行过滤**: 根据匹配结果和阻止模式决定消息处理方式

## 注意事项

- 正则表达式语法错误会导致该模式被跳过并记录警告
- 私聊用户ID格式通常为：`private_qq号`
- 群聊用户ID格式通常为：`group_群号`
- 正则表达式区分大小写，如需忽略大小写请使用`(?i)`标志
- 异常情况下插件会默认放行消息，确保不会意外阻塞正常对话
- 建议在正式使用前先测试正则表达式的匹配效果

## 版本信息

- 版本: 1.0.0
- 作者: xiaoyu  
- 项目地址: https://github.com/yyl0124/message_filter
"""
